<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MSport Data Extractor</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h1>MSport Data Extractor</h1>
    <p class="subtitle">Extract authentication tokens from MSport</p>

    <div class="instructions">
      <strong>How it works</strong>
      <ol>
        <li>Enter your MSport login credentials</li>
        <li>Click "Start Extraction"</li>
        <li>Wait for the tokens to appear</li>
        <li>Optionally forward them to your VM</li>
      </ol>
    </div>

    <!-- Extraction Form -->
    <form id="extractForm">
      <div class="form-group">
        <label for="game">Select Game</label>
        <select id="game" name="game" required>
          <option value="">Choose a game...</option>
          <option value="madpunch">Mad Punch</option>
          <option value="superkick">Super Kick</option>
          <option value="skyace">Sky Ace</option>
        </select>
      </div>

      <div class="form-group">
        <label for="username">Phone Number</label>
        <input
          type="tel"
          id="username"
          name="username"
          placeholder="Enter your phone number"
          required
        />
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <div class="password-toggle">
          <input
            type="password"
            id="password"
            name="password"
            placeholder="Enter your password"
            required
          />
          <button type="button" class="toggle-btn" onclick="togglePassword()" aria-label="Toggle password visibility">
            <span id="toggleIcon">üëÅÔ∏è</span>
          </button>
        </div>
      </div>

      <button type="submit" class="btn" id="extractBtn">Start Extraction</button>
    </form>

    <!-- Extraction Feedback -->
    <div id="statusContainer"></div>
    <div id="resultContainer"></div>

    <!-- Forwarding Section -->
    <div class="forward-section" style="margin-top: 2rem;">
      <h2>Forward Tokens to VM</h2>
      <form id="forwardForm">
        <div class="form-group">
          <label for="vmUrl">VM URL</label>
          <input
            type="text"
            id="vmUrl"
            name="vmUrl"
            placeholder="http://192.168.1.105:4000/api/receive"
            required
          />
        </div>
        <button type="submit" class="btn" id="forwardBtn" disabled>Forward Tokens</button>
      </form>
      <div id="forwardStatus"></div>
    </div>
  </div>

  <script>
    let sessionId = null;
    let pollInterval = null;
    let extractedData = null; // holds last extracted tokens
    let selectedGame = null; // store game selection

    function togglePassword() {
      const input = document.getElementById("password");
      const icon = document.getElementById("toggleIcon");
      const show = input.type === "password";
      input.type = show ? "text" : "password";
      icon.textContent = show ? "üôà" : "üëÅÔ∏è";
    }

    document.getElementById("extractForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      await startExtraction();
    });

    async function startExtraction() {
      const btn = document.getElementById("extractBtn");
      const status = document.getElementById("statusContainer");
      const result = document.getElementById("resultContainer");
      const forwardBtn = document.getElementById("forwardBtn");
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const game = document.getElementById("game").value;

      selectedGame = game; // store for forwarding

      btn.disabled = true;
      forwardBtn.disabled = true;
      result.innerHTML = "";
      status.innerHTML = `
        <div class="status pending">
          <div class="spinner"></div>
          Sending credentials...
        </div>
      `;

      try {
        const res = await fetch("/api/extract", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, game }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Extraction failed.");

        sessionId = data.sessionId;
        status.innerHTML = `
          <div class="status pending">
            <div class="spinner"></div>
            ${data.message} - Logging in automatically...
          </div>
        `;
        pollInterval = setInterval(checkStatus, 2000);
      } catch (err) {
        status.innerHTML = `<div class="status error">${err.message}</div>`;
        btn.disabled = false;
      }
    }

    async function checkStatus() {
      if (!sessionId) return;
      try {
        const res = await fetch(`/api/status/${sessionId}`);
        const data = await res.json();

        const status = document.getElementById("statusContainer");
        const result = document.getElementById("resultContainer");
        const btn = document.getElementById("extractBtn");
        const forwardBtn = document.getElementById("forwardBtn");

        if (data.status === "completed") {
          clearInterval(pollInterval);
          btn.disabled = false;
          forwardBtn.disabled = false;

          extractedData = data.data; // store tokens

          status.innerHTML = `<div class="status completed">Extraction completed successfully</div>`;
          result.innerHTML = `
            <div class="result">
              <div class="result-item">
                <div class="result-label">pAuthorization</div>
                <div class="result-value">${data.data.pAuthorization || "Not found"}</div>
              </div>
            </div>
          `;
        } else if (data.status === "error") {
          clearInterval(pollInterval);
          btn.disabled = false;
          status.innerHTML = `<div class="status error">Error: ${data.data.error}</div>`;
        }
      } catch (err) {
        console.error("Polling error:", err);
      }
    }

    // üü¢ Forwarding logic
    document.getElementById("forwardForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const forwardBtn = document.getElementById("forwardBtn");
      const forwardStatus = document.getElementById("forwardStatus");
      const vmUrl = document.getElementById("vmUrl").value;

      if (!extractedData) {
        return alert("No extracted tokens available. Run extraction first.");
      }

      if (!selectedGame) {
        return alert("Game selection not found. Please extract again.");
      }

      forwardBtn.disabled = true;
      forwardStatus.innerHTML = `<div class="status pending"><div class="spinner"></div>Forwarding to VM...</div>`;

      try {
        const res = await fetch("/api/forward", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            vmUrl,
            pAuthorization: extractedData.pAuthorization,
            game: selectedGame,
          }),
        });
        const data = await res.json();

        if (data.success) {
          forwardStatus.innerHTML = `<div class="status completed">‚úÖ Forwarded successfully to ${data.vmUsed}</div>`;
        } else {
          forwardStatus.innerHTML = `<div class="status error">‚ùå Failed: ${data.error}</div>`;
        }
      } catch (err) {
        forwardStatus.innerHTML = `<div class="status error">‚ùå ${err.message}</div>`;
      } finally {
        forwardBtn.disabled = false;
      }
    });
  </script>
</body>
</html>